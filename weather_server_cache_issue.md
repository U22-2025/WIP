# weather_server キャッシュ機構に関するリスクと改善案

## 1. 概要
weather_server で使用しているキャッシュ実装には、運用・実装上のさまざまな課題が存在します。長期間放置するとメモリ不足やデータ不整合につながり、サービス品質を低下させる恐れがあります。

## 2. 潜在リスクと改善案

### 1. キャッシュデータの不整合
**確認**: `common/utils/cache.py` は `get()` 実行時のみ期限切れをチェックするため、参照されないエントリは残り続きます。
**改善案**: 定期クリーンアップタスクを追加する、またはTTL付きLRU方式へ置き換える。

### 2. キャッシュエントリの肥大化
**確認**: キャッシュサイズの上限がありません。
**改善案**: 保存件数に制限を設け、超過時は古いデータから削除する仕組みを導入する。

### 3. TTL 設定ミスによるデータの陳腐化
**確認**: TTLは `config.ini` に固定され、起動後に変更しても反映されません。
**改善案**: 設定値の動的リロードを実装するか、運用ツールで変更できるようにする。

### 4. キャッシュキー生成ロジックの不備
**確認**: キーが `エリアコード_日付` のみで、取得フラグの組み合わせを区別できません。
**改善案**: フラグ状態をキーに含める、もしくはキャッシュ内に保存されている項目を検証して適切に返却する。

### 5. 排他制御の取り扱い不備
**確認**: `Cache` クラス単体では排他されますが、複数キーをまたぐ処理はアプリケーション側で同期されていません。
**改善案**: 高レベルのロックやトランザクション処理を導入して、複数操作をまとめて保護する。

### 6. 時刻処理のローカル依存
**確認**: 有効期限判定に `datetime.now()` を使用しており、タイムゾーン差異の影響を受けます。
**改善案**: `datetime.utcnow()` またはタイムゾーン情報を含む時刻を利用し、全サーバーで一貫した基準を用いる。

### 7. エラーハンドリング時のキャッシュ挙動
**確認**: キャッシュ保存失敗時はログ出力のみで処理が続行されるため、問題が表面化しにくい状態です。
**改善案**: ログの重要度を上げて監視に通知するほか、リトライやフォールバック処理を検討する。

### 8. データ型不一致の可能性
**確認**: 取り出した値を `int()` キャストする箇所など、期待と異なる型が保存されると例外が発生します。
**改善案**: 入出力時に型チェックを行い、データクラスやスキーマを定義して不正な値を拒否する。

### 9. 並列アクセス時の一貫性問題
**確認**: 同一キーに対して複数スレッドが更新すると、最後に書き込んだ値のみ残り以前の更新が失われる可能性があります。
**改善案**: 排他制御の強化やCAS(compare-and-swap)機構を導入し、同時更新を防ぐ。

### 10. 設定ファイル変更の反映漏れ
**確認**: サーバー起動後に `config.ini` を編集しても再読み込みされません。
**改善案**: ホットリロードや設定変更を検知して再読み込みする仕組みを追加する。

## 3. 関連ファイル
- `WIP_Server/servers/weather_server/weather_server.py`
- `WIP_Server/servers/weather_server/config.ini`
- `common/utils/cache.py`
