# WIP パケット機構 リファクタリング計画

この文書では、WIP (Weather Transfer Protocol) のパケット処理を複数のプログラミング言語で再実装可能な形に整理するための方針をまとめます。Python 実装の構造を参考にしつつ、言語固有の差異を吸収する設計を目指します。

## 1. 全体像
- **共通仕様の定義**: パケットの各フィールドや拡張フィールドは YAML/JSON 形式の設定ファイルに定義します。これを全言語共通のソースとし、実装差異を小さくします。
- **基本パケット構造**: 128 ビット固定のヘッダーを持ちます。フィールド内容は `version`、`packet_id`、`type` などで構成され、リトルエンディアンでエンコードします。
- **拡張フィールド**: `ex_flag` が 1 の場合のみ、ヘッダーの後に可変長のレコード列を追加します。各レコードは `key(6bit)` と `length(10bit)` を含む 16bit ヘッダーに続いてデータを配置します。
- **チェックサム**: 12bit のワンワード補数を採用します。送信前に計算して `checksum` に書き込みます。

## 2. 実装指針
1. **設定ファイルの読み込み**
   - `request_format.yml` や `response_format.yml` を各言語から読み込み、フィールド定義を取得します。
   - 拡張フィールド定義は `extended_fields.yml` で管理します。
2. **ビット列変換アルゴリズム**
   - それぞれのフィールドを規定のビット長で並べ、整数値としてシフト演算で組み立てます。
   - 必要バイト長を計算後、リトルエンディアンでバイト列へ変換します。
   - 受信時は逆にバイト列を整数として読み取り、ビットシフトで値を取得します。
3. **拡張フィールド処理**
   - 拡張フィールドが存在する場合、ヘッダー部で指定した `key` と `length` に基づきデータを解析します。
   - 文字列は UTF-8、座標など数値は適宜整数化してエンコードします。
4. **言語間の統一**
   - フィールド定義ファイルを共有することで、異なる言語でも同一のパケット構造を保ちます。
   - 各言語でテスト用スクリプトを用意し、同じ入力に対して同じ出力が得られるか確認します。
5. **リファクタリングのポイント**
   - Python 実装の `DynamicFormat` クラスのように、設定ファイルから自動的にパケットクラスを生成する仕組みを各言語で用意します。
   - 拡張フィールドの追加や変更を設定ファイルの編集だけで反映できるようにします。

## 3. サーバ構成との関係
- **Weather Server**: クライアントからの要求を受け取り、Query Server や Location Server へ転送します。
- **Location Server**: 座標から地域コードを計算し、キャッシュします。
- **Query Server**: 気象庁データを取得・加工し、レスポンスパケットを生成します。
- これらのサーバは共通ライブラリを利用しつつ、パケット定義ファイルを参照してデータをやり取りします。

## 4. 他言語実装の進め方
1. まず YAML/JSON の定義を読み込むパーサを作成します。
2. ビット操作を扱うユーティリティを整備し、エンディアンを意識した変換処理を実装します。
3. 既存の Python テストケースを参考に、各言語で同等のテストを作成します。
4. 追加機能が必要な場合も、まず定義ファイルを更新し、全言語での動作確認を行います。

この方針に従うことで、言語に依存しない形で WIP パケット機構を統一的に扱うことができます。
