flowchart TD
    A[気象庁API] -->|データ取得| B[WeatherRedisStore]
    B1[ローカルJSONファイル] -->|ファイル読み込み| B
    
    B -->|store_weather_data| C{データ処理}
    
    C -->|オフィス情報| D[オフィスデータの保存]
    D -->|office:{code}| DB[(Redisデータベース)]
    D -->|office_data:{code}| DB
    
    C -->|エリア情報抽出| E[_extract_area_data]
    
    E -->|短期予報処理| F1[_process_time_series]
    E -->|週間予報処理| F2[_process_time_series]
    E -->|平均気温データ処理| F3[_process_average_data]
    E -->|平均降水量データ処理| F4[_process_average_data]
    
    F1 -->|時系列データ保存| G[各種データ保存処理]
    F2 -->|時系列データ保存| G
    F3 -->|平均データ保存| G
    F4 -->|平均データ保存| G
    
    G -->|エリア基本情報| DB
    G -->|日付別データ| DB
    G -->|データ種別別| DB
    G -->|時間別逆引き| DB
    G -->|時系列JSONキャッシュ| DB
    G -->|シリーズインデックス| DB
    G -->|平均データ| DB
    
    C -->|全エリア情報| H[エリアマップ更新]
    H -->|all_areas| DB
    
    C -->|最終更新時刻| I[更新時刻記録]
    I -->|weather:last_updated| DB
