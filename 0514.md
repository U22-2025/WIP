# weatherプロトコル ( WTP )　仕様書

## 概要
- NTPをベースとしたプロトコル
- 気象庁の公開している気象情報、災害情報をXML形式で取得して、weatherプロトコルに変換して提供する。 ( https://xml.kishou.go.jp/xmlpull.html )
- リクエストに含まれたデータから、レスポンスするデータを絞り込んで返信する。
- IoT機器でも使用できるように、小さなデータで通信を行う。

## 詳細
- クライアントのリクエストに対してサーバがレスポンスを返す、1:1のメッセージ交換形式で情報を取得する
- サーバは分散してデータを保持し、ルートサーバにアクセスすることで、そのデータを保持するサーバへのIPアドレスを取得する。
そして再度IPアドレス宛にデータを要求。


## 情報の取得について
気象庁定義の地域コードを基に、気象台別ページから取得する
- 気象情報
    - 定期更新
    - 気象台別ページ https://www.jma.go.jp/bosai/forecast/data/forecast/xx.json
        - xx.jsonを「地域コード.json」の形式に置き換えて取得
            - 地域コード https://www.jma.go.jp/bosai/common/const/area.json

- 災害情報
    - リクエストがあった場合に取得、更新されているかどうかチェックする。
        - 注意報・警報
            - 定時更新 ( 見込み含む ) https://www.data.jma.go.jp/developer/xml/feed/regular.xml
            - 随時更新 https://www.data.jma.go.jp/developer/xml/feed/extra.xml

        - 地震・噴火等
            - 連続したリクエストがあれば、1回目以降のチェック処理を省略。
            - https://www.data.jma.go.jp/developer/xml/feed/eqvol.xml


## リクエスト・レスポンスデータについて
以下の項目をパケットに含める

- 指定する地域 64ビット　× 2
    - 0x0000 0000 0000 0000
    - 地名を緯度と経度（ 16進数 ）に変換
    - 指定されていなかったら送信元の緯度経度を取得

- 指定する時間 3ビット
    - 0 : 今日
    - 1 : 明日
    - 2 : 明後日
    - 3 : 3日後
    - 以下同様
        - 指定された時間のデータをサーバが持っていない場合、最も遠い日付のデータを返す
- フラグ ( 0 取得しない / 1 取得する)　5ビット
    - 天気の有無
    - 気温の有無
    - 降水確率の有無
    - 気象注意報・警報の有無
    - 災害情報の有無


## プロトコル詳細
- NTPベースのアプリケーションプロトコル
- MAC, IP, UDPの既存プロトコルを使用

- アプリケーションデータがリクエスト、レスポンスともに48バイト程度に抑える。
- バイナリデータで送受信を行う。

### プロトコルフォーマット
##### total 272bit ( 34byte )

- バージョン 4ビット
    - "0001" ( バージョン1 )

- Type 1ビット
    - "0" / "1" ( リクエスト / レスポンス )

- 時間指定フィールド 3ビット
    - "000"

- フラグフィールド 5ビット
    - 天気取得
    - 気温取得
    - 降水確率取得
    - 気象注意報・警報取得
    - 災害情報取得

- IP バージョン 3ビット
    - "100" / "110" ( ipv4 / ipv6 )
    - 拡張フィールドに格納されるIPアドレスのバージョンを示す。
        - IPアドレスは、ルートサーバから返答されるもの。
    - 返答されない場合は "000"

- パケットID 16ビット
    - "0x0000"
    - パケットの識別に使用 ( 重複防止 )

- 地域 ( 緯度経度 ) 128ビット
    - "0x0000 0000 0000 0000" × 2
    - 緯度と経度で64ビットずつ

- タイムスタンプ 64ビット
    - "0x0000 0000 0000 0000"
    - UNIX時間形式

- 天気コード 16ビット
    - "0x0000"
    - weather_code.md参照、16進数に変換

- 気温 24ビット
    - "0x0000 00" 
    - 2の補数でマイナス気温に対応
    - 先頭8ビットで現在の気温
    - 後続8ビットで最高気温
    - 末尾8ビットで最低気温

- 降水確率 5ビット
    - "0000 0"
    - 5%単位で表現
        - "0010 1" ( 0d5 )なら、5% × 5 で25%。

- 予約フィールド 3ビット
    - 何もなければゼロパディング

- 拡張フィールド　可変長
    - バイナリデータで送信
    - IPアドレスや注意報・警報、災害情報を格納
    - データ毎にデータ長を示すヘッダを付加
        - ヘッダサイズ 16ビット
            - 8ビット単位で表現 ( Maxデータ長 65535バイト )
            - ヘッダが "0x0010" であれば 128ビット ( 16 × 8 ) のデータを格納できる。
        - 暴風警報と地震情報を送信する場合
        
        | ヘッダ     | 暴風情報データ | ヘッダ | 地震情報 |
        |----------------|---------------|-----------------|----------|
        | 16バイト        |暴風注意報が出ています| 12バイト   | 0時0分に地震発生:震度3|


| フィールド名         | ビット数 | バイト数 | 内容説明                                                                 |
|----------------------|----------|----------|--------------------------------------------------------------------------|
| バージョン           | 4        |     | プロトコルバージョン（例: `0001` = バージョン1）                        |
| Type                 | 1        |    | 0: リクエスト / 1: レスポンス                                           |
| 時間指定             | 3        |     | 0: 今日 / 1: 明日 / 2: 明後日 … 最大7日後                              |
| フラグフィールド     | 5        |   | 各ビットが、天気・気温・降水・注意報・災害情報の有無を指定             |
| IPバージョン  | 4        |          |IPアドレスのバージョン                                                       |
| パケットID           | 12       | 2        | パケット識別用（重複防止）                                              |
| 地域（緯度・経度）   | 128      | 16       | 緯度64ビット + 経度64ビット（16進数のバイナリ）                        |
| タイムスタンプ       | 64       | 8        | UNIX時間形式（秒単位）                                                  |
| 天気コード           | 16       | 2        | weather_code.md 参照、天気を表すコード                                  |
| 気温                 | 24       | 3        | 8bitごとに現在 / 最高 / 最低気温。2の補数で負値も表現可能              |
| 降水確率             | 5        |    | 5%単位で表現（例: `00101` = 25%）                                       |
| 予約フィールド       | 3        |     | ゼロパディング                                                           |
| 拡張フィールド       | 可変     | 可変     | 注意報・警報・災害情報、IPアドレス等を含む。先頭に16bitの長さヘッダ付き |


## サーバの動作・仕様
### 分散型の場合↓
#### ルートサーバ
- 地域のデータを保持する下位サーバのIPアドレスを保持する。
- リクエストを受けたとき、対応する座標のデータを保持するサーバのIPアドレスを返す。
    - 拡張フィールドにIPアドレスを入れて、下位サーバ宛に折り返しリクエストを送信させる。

#### 下位サーバ
- 担当する地域の気象情報を取得・保持する。
- 災害情報XMLに担当する地域に関する更新がされているかどうかチェック。
- リクエストされたデータに対応するデータをレスポンスとして返す。

### 1台完結型の場合↓
- IPアドレスに関するフィールドが不要になる。
#### サーバ
- 全地域の気象情報を取得・保持する。
- 災害情報XMLを取得し、更新がされているかどうかチェック。
    - 更新がされていれば、バッファに入れ、連続するリクエストに対して同じデータを返す。
        - 緊急性が高いため、バッファは短い時間で破棄する。
- リクエストされたデータに対応するデータをレスポンスとして返す。


## 実装しないと思うアイデア廃棄場
- クライアント認証機能
- 送信元の制限
- NTPのKODパケット的なDoS対策、アクセスの多い送信元に対してアクセスを抑制させる。

### 注釈等
- 「0x00」は16進数
- 「0d00」は10進数
