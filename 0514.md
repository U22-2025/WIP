# weatherプロトコル　仕様書

## 概要
- NTPをベースとしたプロトコル
- 気象庁の公開している気象情報、災害情報をXML形式で取得して、weatherプロトコルに変換して提供する。 ( https://xml.kishou.go.jp/xmlpull.html )
- リクエストに含まれたデータから、レスポンスするデータを絞り込んで返信する。
- IoT機器でも使用できるように、小さなデータで通信を行う。

## 詳細
- クライアントのリクエストに対してサーバがレスポンスを返す、1:1のメッセージ交換形式で情報を取得する


## 情報の取得について
- 気象庁定義の地域コードを基に、気象台別ページから取得する
    - 気象台別ページ https://www.jma.go.jp/bosai/forecast/data/forecast/xx.json
        - xx.jsonを「地域コード.json」の形式に置き換えて取得
            - 地域コード https://www.jma.go.jp/bosai/common/const/area.json

    - 注意報・警報
        - 定時更新 ( 見込み含む ) https://www.data.jma.go.jp/developer/xml/feed/regular.xml
        - 随時更新 https://www.data.jma.go.jp/developer/xml/feed/extra.xml
    - 地震・噴火等
        - https://www.data.jma.go.jp/developer/xml/feed/eqvol.xml


## リクエスト/レスポンスデータについて
以下の項目をパケットに含める

- 指定する地域 64ビット　× 2
    - 0x0000 0000 0000 0000
    - 地名を緯度と経度（ 16進数 ）に変換
    - 指定されていなかったら送信元の緯度経度を取得

- 指定する時間 3ビット
    - 0 : 今日
    - 1 : 明日
    - 2 : 明後日
    - 3 : 3日後
    - 以下同様
        - 指定された時間のデータをサーバが持っていない場合、最も遠い日付のデータを返す
- フラグ ( 0 取得しない / 1 取得する)
    - 天気の有無
    - 気温の有無
    - 降水確率の有無
    - 気象注意報・警報の有無
    - 災害情報の有無


## プロトコル詳細
- NTPベースのアプリケーションプロトコル
- MAC, IP, UDPの既存プロトコルを使用

- アプリケーションデータがリクエスト、レスポンスともに48バイト程度

### プロトコルフォーマット
- バージョン 4ビット
    - 0001 ( バージョン1 )

- Type 1ビット
    - 0 リクエスト / 1 レスポンス

- パケットID 16ビット
    - 0x0000
    - パケットの識別に使用 ( 重複防止 )

- 地域 ( 緯度経度 ) 128ビット
    - 0x0000 0000 0000 0000 × 2
    - 緯度と経度で64ビットずつ

- タイムスタンプ 64ビット
    - 0x0000 0000 0000 0000 ( UNIX時間形式 )

- 天気コード 16ビット
    - 0x0000 weather_code.md参照、16進数に変換

- 気温 24ビット
    - 0x000000 2の補数でマイナス気温に対応させる
    - 先頭8ビットで現在の気温
    - 後続8ビットで最高気温
    - 末尾8ビットで最低気温

- 降水確率 5ビット
    - 00000
    - 5%単位で表現
        - 00101 ( 10進数で5 )なら、5% × 5 で25%。

- 災害情報　可変長
    -　バイナリデータで送信
    - データの毎にデータ長を示すヘッダを付加
        - 暴風警報と地震情報を送信する場合
        ```
        | 暴風情報データ長 | 暴風情報データ | 地震情報データ長 | 地震情報 |
        |----------------|---------------|-----------------|----------|
        | 16バイト        |暴風注意報が出ています| 12バイト   | 0時0分に地震発生:震度3|
        ```
