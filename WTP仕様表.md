# weatherプロトコル ( WTP )　仕様書

## 概要
- NTPをベースとしたプロトコル
- ポート番号 UDP/4110を使用する。
- 気象庁の公開している気象情報、災害情報をXML形式で取得して、weatherプロトコルに変換して提供する。 ( https://xml.kishou.go.jp/xmlpull.html )
- リクエストに含まれたデータから、レスポンスするデータを絞り込んで返信する。
- IoT機器でも使用できるように、小さなデータで通信を行う。
- クライアントのリクエストに対してサーバがレスポンスを返す、1:1のメッセージ交換形式で情報を取得する
- サーバは分散してデータを保持し、ルートサーバにアクセスすることで、その地域のデータを保持する下位サーバへのFQDNを取得 → 下位サーバ宛にデータを要求。


## 情報の取得について
気象庁定義の地域コードを基に、気象台別ページから取得する
- 気象情報
    - 定期更新
    - 気象台別ページ https://www.jma.go.jp/bosai/forecast/data/forecast/xx.json
        - xx.jsonを「地域コード.json」の形式に置き換えて取得
            - 地域コード https://www.jma.go.jp/bosai/common/const/area.json

- 災害情報
    - リクエストがあった場合に取得、更新されているかどうかチェックする。
        - 注意報・警報
            - 定時更新 ( 見込み含む ) https://www.data.jma.go.jp/developer/xml/feed/regular.xml
            - 随時更新 https://www.data.jma.go.jp/developer/xml/feed/extra.xml

        - 地震・噴火等
            - 連続したリクエストがあれば、1回目以降のチェック処理を省略。
            - https://www.data.jma.go.jp/developer/xml/feed/eqvol.xml

## プロトコル詳細
- NTPベースのアプリケーションプロトコル
- MAC, IP, UDPの既存プロトコルを使用

- アプリケーションデータがリクエスト、レスポンスともに48バイト程度に抑える。
- バイナリデータで送受信を行う。

### プロトコルフォーマット
protocol_format.xlsx参照

### プロトコル内データ

- バージョン 4ビット
    - "0001" ( バージョン1 )

- パケットID 12ビット
    - "0x0000"
    - パケットの識別に使用 ( 重複防止 )

- Type 3ビット
    - "001" / "010" ( リクエスト / レスポンス )

- フラグフィールド 6ビット
    - 天気取得
    - 気温取得
    - 降水確率取得
    - 気象注意報・警報取得
    - 災害情報取得
    - 拡張フィールドの使用

- タイムスタンプ 64ビット
    - "0x0000 0000 0000 0000"
    - UNIX時間形式

- チェックサム 12ビット
    - パケットのビット誤り検出用
        - 誤り検出時、パケットを破棄する。
    - チェックサム対象 : WTPパケット全体
    - チェックサム算出時、パケットの頭から116ビット目～128ビット目までを0に置き換えて計算 

- 時間指定フィールド 3ビット
    - "000"
    - 何日後のデータを取得するか
        - 0なら当日
        - 1なら翌日
        - 2なら明後日
        - 3なら3日後
        - 以下同様

- 地域 ( 緯度・経度 ) 64ビット
    - "0x0000 0000 0000 0000" × 2
    - 緯度と経度で64ビットずつ
    - 空の座標解決リクエストパケットではサーバが送信元アドレスを基に座標を検索

- 地域コード　20ビット
    - "000000"
    - 座標解決により取得した地域コードを格納

- 天気コード 16ビット
    - "0x0000"
    - weather_code.md参照、16進数に変換

- 気温 8ビット
    - "0x0000 00" 
    - 2の補数でマイナス気温に対応
    - 先頭8ビットで現在の気温

- 降水確率 8ビット
    - "0000 0000"
    - 1%単位で表現
        - "0000 0101" ( 0d5 )なら、5 × 1% で5%。

- 予約フィールド 4ビット
    - 何もなければゼロパディング

- 拡張フィールド　可変長
    - バイナリデータで送信
    - 注意報・警報、災害情報を格納
    - データ毎にデータ長を示すヘッダを付加
        - ヘッダサイズ 24ビット
            - データ長 16ビット
                - 8ビット単位で表現 ( Maxデータ長 65535バイト )
                - ヘッダが "0x0010" であれば 128ビット ( 16 × 8 ) のデータを格納できる。
            - データ種別 8ビット
              - 前半4ビットで種類の区分、後半4ビットで詳細
                - "0000 0001" 注意報
                - "0000 0010" 警報
                - "0000 0011" 災害情報
                - "0001 0000" 緯度
                - "0001 0001" 経度
                - "0010 0000" 代理サーバが参照する送信元IPアドレス

## サーバ・クライアントの動作
#### WTPサーバ
- UDP/41110で待機
- リクエスト受信し、送信元IPに対してレスポンスを返す


#### 代理サーバ
- UDP/4110で待機
- 処理の流れ
  - WTPパケットを受け取る
    - 地域コードなし
      - PostgreSQLを参照して座標解決
  - 代理クライアントとしてWTPサーバのUDP/4110へ代理リクエスト送信
    - この時にクライアントの送信元を拡張フィールドに追加
  - レスポンスを受信すると、拡張フィールドを参照して、宛先IPアドレスをセット。レスポンス送信。


### クライアント
- サーバに対して取得したい地域の「緯度経度」をデータ部に含んでリクエスト
    - 解決されたキャッシュはローカルに保存しておく。
- 地域コードを基に下位サーバへアクセス

## キャッシュの仕様
- クライアントでは、問い合わせる座標のキャッシュを保持していないか確認
    - キャッシュ時間を超過しているなら破棄
- 以下の項目をキャッシュする
    - 経度
    - 緯度
    - 地域コード
    - 対応するサーバのFQDN
    - キャッシュ時間

## 実装しないと思うアイデア廃棄場
- クライアント側で地域コードをキャッシュする機能
- クライアント認証機能
- 送信元の制限
- NTPのKODパケット的なDoS対策、アクセスの多い送信元に対してアクセスを抑制させる。
- リクエスト・レスポンス両方にパケット長フィールドを追加


