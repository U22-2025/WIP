jobs:
  build:
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        working-directory: cpp/wip
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]

    steps:
      - uses: actions/checkout@v4

      - name: Clone vcpkg
        run: |
          git clone https://github.com/microsoft/vcpkg.git
          ./vcpkg/bootstrap-vcpkg${{ contains(matrix.os, 'windows') && '.bat' || '.sh' }}
        shell: bash

      - name: Install build tools (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: sudo apt-get update && sudo apt-get install -y ninja-build g++ cmake

      # ✅ Visual Studio 環境をセットアップ
      - name: Setup MSVC
        if: matrix.os == 'windows-latest'
        uses: microsoft/setup-msbuild@v2

      - name: Install build tools (Windows)
        if: matrix.os == 'windows-latest'
        run: choco install ninja cmake

      - name: Configure
        run: cmake --preset ${{ contains(matrix.os, 'windows') && 'x64-debug' || 'linux-debug' }}

      - name: Build
        run: cmake --build --preset ${{ contains(matrix.os, 'windows') && 'x64-debug' || 'linux-debug' }}

      - name: Test
        run: ctest --preset ${{ contains(matrix.os, 'windows') && 'x64-debug' || 'linux-debug' }} --output-on-failure
